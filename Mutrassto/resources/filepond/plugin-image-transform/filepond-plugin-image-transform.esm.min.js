/*!
 * FilePondPluginImageTransform 3.2.4
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://pqina.nl/filepond/ for details.
 */

/* eslint-disable */

const t=(t,e)=>({x:t,y:e}),e=(e,n)=>t(e.x-n.x,e.y-n.y),n=(t,n)=>Math.sqrt(((t,n)=>((t,e)=>t.x*e.x+t.y*e.y)(e(t,n),e(t,n)))(t,n)),a=(e,n)=>{const a=e,i=n,r=1.5707963267948966-n,o=Math.sin(1.5707963267948966),h=Math.sin(i),l=Math.sin(r),s=Math.cos(r),g=a/o;return t(s*(g*h),s*(g*l))},i=(e,i,r=0,o={x:.5,y:.5})=>{const h=o.x>.5?1-o.x:o.x,l=o.y>.5?1-o.y:o.y,s=2*h*e.width,g=2*l*e.height,d=((e,i)=>{const r=e.width,o=e.height,h=a(r,i),l=a(o,i),s=t(e.x+Math.abs(h.x),e.y-Math.abs(h.y)),g=t(e.x+e.width+Math.abs(l.y),e.y+Math.abs(l.x)),d=t(e.x-Math.abs(l.y),e.y+e.height-Math.abs(l.x));return{width:n(s,g),height:n(s,d)}})(i,r);return Math.max(d.width/s,d.height/g)},r=(t,e)=>{let n=t.width,a=n*e;return a>t.height&&(n=(a=t.height)/e),{x:.5*(t.width-n),y:.5*(t.height-a),width:n,height:a}},o={1:()=>[1,0,0,1,0,0],2:t=>[-1,0,0,1,t,0],3:(t,e)=>[-1,0,0,-1,t,e],4:(t,e)=>[1,0,0,-1,0,e],5:()=>[0,1,1,0,0,0],6:(t,e)=>[0,1,-1,0,e,0],7:(t,e)=>[0,-1,-1,0,e,t],8:t=>[0,-1,1,0,0,t]},h=t=>t&&(t.horizontal||t.vertical),l=(t,e,n)=>{if(!e&&!h(n))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;const a=document.createElement("canvas"),i=t.naturalWidth,r=t.naturalHeight,l=e>=5&&e<=8;l?(a.width=r,a.height=i):(a.width=i,a.height=r);const s=a.getContext("2d");if(e&&s.transform.apply(s,((t,e,n)=>(-1===n&&(n=1),o[n](t,e)))(i,r,e)),h(n)){const t=[1,0,0,1,0,0];(!l&&n.horizontal||l&n.vertical)&&(t[0]=-1,t[4]=i),(!l&&n.vertical||l&&n.horizontal)&&(t[3]=-1,t[5]=r),s.transform.apply(s,t)}return s.drawImage(t,0,0,i,r),a},s=(t,e,n)=>{n||(n={});const a=l(t,e,n.flip),o={width:a.width,height:a.height},h=document.createElement("canvas"),s=n.aspectRatio||o.height/o.width,g=((t,e,n=1)=>{const a=t.height/t.width;let i=e,r=1,o=a;o>i&&(r=(o=i)/a);const h=Math.max(1/r,i/o),l=t.width/(n*r*h),s=l*e;return{width:Math.round(l),height:Math.round(s)}})(o,s,n.zoom);h.width=g.width,h.height=g.height;const d={x:.5*h.width,y:.5*h.height},c=d.x-o.width*(n.center?n.center.x:.5),m=d.y-o.height*(n.center?n.center.y:.5),u={x:0,y:0,width:h.width,height:h.height,center:d},p=i(o,r(u,s),n.rotation,n.center),w=(n.zoom||1)*p,f=h.getContext("2d");return f.translate(d.x,d.y),f.rotate(n.rotation||0),f.scale(w,w),f.drawImage(a,c-d.x,m-d.y,o.width,o.height),f.getImageData(0,0,h.width,h.height)},g=()=>{const t={resize:function(t,e){const{mode:n,upscale:a}=e;let{width:i,height:r}=e.size;null===i?i=r:null===r&&(r=i);if("force"!==n){let e=i/t.width,o=r/t.height,h=1;if("cover"===n?h=Math.max(e,o):"contain"===n&&(h=Math.min(e,o)),h>1&&!1===a)return t;i=t.width*h,r=t.height*h}const o=t.width,h=t.height,l=Math.round(i),s=Math.round(r);for(var g=t.data,d=new Uint8ClampedArray(l*s*4),c=o/l,m=h/s,u=Math.ceil(c/2),p=Math.ceil(m/2),w=0;w<s;w++)for(var f=0;f<l;f++){for(var T=4*(f+w*l),y=0,M=0,A=0,_=gx_g=gx_b=gx_a=0,x=(w+.5)*m,E=Math.floor(w*m);E<(w+1)*m;E++)for(var R=Math.abs(x-(E+.5))/p,I=(f+.5)*c,v=R*R,O=Math.floor(f*c);O<(f+1)*c;O++){var b=Math.abs(I-(O+.5))/u,F=Math.sqrt(v+b*b);F>=-1&&F<=1&&(y=2*F*F*F-3*F*F+1)>0&&(b=4*(O+E*o),gx_a+=y*g[b+3],A+=y,g[b+3]<255&&(y=y*g[b+3]/250),_+=y*g[b],gx_g+=y*g[b+1],gx_b+=y*g[b+2],M+=y)}d[T]=_/M,d[T+1]=gx_g/M,d[T+2]=gx_b/M,d[T+3]=gx_a/A}return{data:d,width:l,height:s}}},e=(e,n)=>{n(((e,n)=>(e.forEach(e=>{const a=t[e.type];a&&(n=a(n,e.data))}),n))(e.transforms,e.imageData))};self.onmessage=(t=>{e(t.data.message,e=>{self.postMessage({id:t.data.id,message:e},[e.data.buffer])})})},d=(t,e,n)=>{if(1165519206!==t.getUint32(e+4,!1))return;e+=4;const a=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,a);const i=t.getUint16(e,a);e+=2;for(let n=0;n<i;n++)if(274===t.getUint16(e+12*n,a))return t.setUint16(e+12*n+8,1,a),!0;return!1},c=t=>new Promise((e,n)=>{const a=new FileReader;a.onload=(()=>e((t=>{const e=new DataView(t);if(65496!==e.getUint16(0))return null;let n,a,i=2,r=!1;for(;i<e.byteLength&&(n=e.getUint16(i,!1),a=e.getUint16(i+2,!1)+2,n>=65504&&n<=65519||65534===n)&&(r||(r=d(e,i)),!(i+a>e.byteLength));)i+=a;return t.slice(0,i)})(a.result)||null)),a.readAsArrayBuffer(t.slice(0,262144))}),m=({loadImage:t,createWorker:e,getFilenameWithoutExtension:n,getFileFromBlob:a})=>{const i=(t,e,i)=>new Promise((r,o)=>{const h=e=>{const i=a(e,((t,e)=>{return`${n(t)}.${"image/jpeg"===e?"jpg":e.split("/")[1]}`})(t.name,(t=>"image/jpeg"===t||"image/png"===t?t:"image/jpeg")(e.type)));r(i)};((t,e)=>new Promise((n,a)=>{const i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").putImageData(t,0,0),i.toBlob(n,e.type,e.quality)}))(e,i).then(e=>{i.stripImageHead?h(e):c(t).then(t=>{null!==t&&(e=new Blob([t,e.slice(20)],{type:e.type})),h(e)})}).catch(t=>{console.error(t)})});return(n,a,r,o)=>new Promise((h,l)=>{const d=t=>{if(n.archived)return h(a);const l=(r.find(t=>"crop"===t.type)||{}).data,d=s(t,(n.getMetadata("exif")||{}).orientation||-1,l);if(!r.length)return i(a,d,o).then(h);const c=e(g);c.post({transforms:r,imageData:d},t=>{if(n.archived)return h(a);i(a,(t=>{let e;try{e=new ImageData(t.width,t.height)}catch(n){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e})(t),o).then(h),c.terminate()},[d.data.buffer])},c=URL.createObjectURL(a);t(c).then(t=>{URL.revokeObjectURL(c),d(t)})})};"undefined"!=typeof window&&void 0!==window.document&&(HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,n){const a=this;setTimeout(()=>{const i=a.toDataURL(e,n).split(",")[1],r=atob(i);let o=r.length;const h=new Uint8Array(o);for(;o--;)h[o]=r.charCodeAt(o);t(new Blob([h],{type:e||"image/png"}))})}}));const u=({addFilter:t,utils:e})=>{const{Type:n,forin:a,loadImage:o,getFileFromBlob:h,getFilenameWithoutExtension:l,createWorker:s,createBlob:g,renameFile:d,isFile:c}=e,u=["crop","resize"],p=m({loadImage:o,createWorker:s,getFileFromBlob:h,getFilenameWithoutExtension:l}),w=(({createBlob:t,renameFile:e})=>(n,a,o)=>new Promise((h,l)=>{const s=(o.find(t=>"crop"===t.type)||{}).data;if(!s)return h(a);const g=new FileReader;g.onloadend=(()=>{if(n.archived)return h(a);const o=g.result,l=document.createElement("div");l.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",l.innerHTML=o;const d=l.querySelector("svg");document.body.appendChild(l);const c=d.getBBox();l.parentNode.removeChild(l);const m=l.querySelector("title"),u=d.getAttribute("viewBox")||"",p=d.getAttribute("width")||"",w=d.getAttribute("height")||"";let f=parseFloat(p)||null,T=parseFloat(w)||null;const y=(p.match(/[a-z]+/)||[])[0]||"",M=(w.match(/[a-z]+/)||[])[0]||"",A=u.split(" ").map(parseFloat),_=A.length?{x:A[0],y:A[1],width:A[2],height:A[3]}:c;let x=null!=f?f:_.width,E=null!=T?T:_.height;d.style.overflow="visible",d.setAttribute("width",x),d.setAttribute("height",E);const R=s.aspectRatio||E/x,I=x,v=I*R,O=i({width:x,height:E},r({width:I,height:v},R),s.rotation,s.center),b=s.zoom*O,F=.5*I,N=.5*v,U=[`rotate(${s.rotation*(180/Math.PI)} ${F} ${N})`,`translate(${F} ${N})`,`scale(${b})`,`translate(${-F} ${-N})`,`translate(${F-x*s.center.x} ${N-E*s.center.y})`],G=[`scale(${s.flip.horizontal?-1:1} ${s.flip.vertical?-1:1})`,`translate(${s.flip.horizontal?-x:0} ${s.flip.vertical?-E:0})`],P=`<?xml version="1.0" encoding="UTF-8"?>\n<svg width="${I}${y}" height="${v}${M}" \nviewBox="0 0 ${I} ${v}" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>${m?m.textContent:a.name}</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="${U.join(" ")}">\n<g transform="${G.join(" ")}">\n${d.outerHTML}\n</g>\n</g>\n</svg>`;h(e(t(P,"image/svg+xml"),a.name))}),g.readAsText(a)}))({createBlob:g,renameFile:d});return t("SHOULD_PREPARE_OUTPUT",(t,{query:e,item:n})=>new Promise(t=>{t(!e("IS_ASYNC"))})),t("PREPARE_OUTPUT",(t,{query:e,item:n})=>new Promise(i=>{if(!c(t)||!(t=>/^image/.test(t.type))(t)||!e("GET_ALLOW_IMAGE_TRANSFORM")||n.archived)return i(t);const r=[];e("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_ORIGINAL")&&r.push(()=>new Promise(n=>{n({name:e("GET_IMAGE_TRANSFORM_VARIANTS_ORIGINAL_NAME"),file:t})})),e("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_DEFAULT")&&r.push((t,n,a)=>new Promise(i=>{t(n,a).then(t=>i({name:e("GET_IMAGE_TRANSFORM_VARIANTS_DEFAULT_NAME"),file:t}))}));const o=e("GET_IMAGE_TRANSFORM_VARIANTS")||{};a(o,(t,e)=>{const n=(t=>(e,n,a)=>e(n,t?t(a):a))(e);r.push((e,a,i)=>new Promise(r=>{n(e,a,i).then(e=>r({name:t,file:e}))}))});const h=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),l=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),s=null===h?null:h/100,g=e("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),d=e("GET_IMAGE_TRANSFORM_CLIENT_TRANSFORMS")||u;n.setMetadata("output",{quality:s,type:g,client:d},!0);const m=(t,i)=>new Promise((r,o)=>{const h=[];a(i,(t,e)=>{d.includes(t)&&h.push({type:t,data:e})}),(t=>{t.sort((t,e)=>{const n=u.indexOf(t.type),a=u.indexOf(e.type);return n<a?-1:n>a?1:0})})(h);const{type:s,quality:g}=i.output||{};return 0!==h.length||null!==g&&(null===g||"optional"!==l)||null!==s&&s!==t.type?/svg/.test(t.type)&&null===s?w(n,t,h).then(r):void p(n,t,h,{type:s||t.type,quality:g,stripImageHead:e("GET_IMAGE_TRANSFORM_OUTPUT_STRIP_IMAGE_HEAD")}).then(r):r(t)}),f=r.map(e=>e(m,t,n.getMetadata()));Promise.all(f).then(t=>{i(1===t.length&&null===t[0].name?t[0].file:t)})})),{options:{allowImageTransform:[!0,n.BOOLEAN],imageTransformOutputMimeType:[null,n.STRING],imageTransformOutputQuality:[null,n.INT],imageTransformOutputStripImageHead:[!0,n.BOOLEAN],imageTransformClientTransforms:[null,n.ARRAY],imageTransformOutputQualityMode:["always",n.STRING],imageTransformVariants:[null,n.OBJECT],imageTransformVariantsIncludeDefault:[!0,n.BOOLEAN],imageTransformVariantsDefaultName:[null,n.STRING],imageTransformVariantsIncludeOriginal:[!1,n.BOOLEAN],imageTransformVariantsOriginalName:["original_",n.STRING]}}};"undefined"!=typeof window&&void 0!==window.document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:u}));export default u;
